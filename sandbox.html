<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Auto Plaid Bank Connection</title>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: "#f0f9ff",
                100: "#e0f2fe",
                200: "#bae6fd",
                300: "#7dd3fc",
                400: "#38bdf8",
                500: "#0ea5e9",
                600: "#0284c7",
                700: "#0369a1",
                800: "#075985",
                900: "#0c4a6e",
              },
            },
            animation: {
              "spin-slow": "spin 3s linear infinite",
            },
          },
        },
      };
    </script>
  </head>
  <body class="bg-gray-50 min-h-screen flex flex-col">
    <!-- Header -->
    <header
      class="bg-white shadow-sm border-b border-gray-200 sticky top-0 z-10"
    >
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16 items-center">
          <div class="flex items-center">
            <div class="flex-shrink-0 flex items-center">
              <div
                class="h-8 w-8 bg-primary-600 rounded flex items-center justify-center"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-5 w-5 text-white"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                >
                  <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z" />
                  <path
                    fill-rule="evenodd"
                    d="M18 9H2v5a2 2 0 002 2h12a2 2 0 002-2V9zM4 13a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z"
                    clip-rule="evenodd"
                  />
                </svg>
              </div>
              <span class="ml-2 text-xl font-semibold text-gray-900"
                >Plaid Connect</span
              >
            </div>
          </div>
          <div class="hidden md:flex items-center space-x-4">
            <span
              class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary-100 text-primary-800"
            >
              <svg
                class="mr-1.5 h-2 w-2 text-primary-600"
                fill="currentColor"
                viewBox="0 0 8 8"
              >
                <circle cx="4" cy="4" r="3" />
              </svg>
              Secure Connection
            </span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div
          class="bg-white rounded-lg shadow-md overflow-hidden border border-gray-200 transition-all duration-300 hover:shadow-lg"
        >
          <!-- Card Header -->
          <div class="border-b border-gray-200 bg-gray-50 px-6 py-5">
            <h2 class="text-xl font-semibold text-gray-800">
              Connect Your Bank Account
            </h2>
            <p class="mt-1 text-sm text-gray-600">
              Securely link your bank account using Plaid's trusted service
            </p>
          </div>

          <!-- Card Body -->
          <div class="px-6 py-8">
            <div class="flex flex-col items-center">
              <!-- Connection Button -->
              <div class="mb-8 text-center">
                <button
                  id="connect-button"
                  class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 transition-all duration-200 transform hover:-translate-y-0.5 active:translate-y-0"
                >
                  <span>Start Bank Connection</span>
                </button>
                <p class="mt-2 text-sm text-gray-500">
                  Click to securely connect your bank account
                </p>
              </div>

              <!-- Status Message -->
              <div id="status-message" class="w-full mb-6 hidden"></div>

              <!-- Connection Status -->
              <div
                class="w-full bg-primary-50 rounded-lg p-5 border border-primary-200"
              >
                <div class="flex items-center justify-between mb-3">
                  <h3 class="text-sm font-medium text-gray-900">
                    Connection Status
                  </h3>
                  <span
                    id="connection-badge"
                    class="px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800"
                  >
                    Not Connected
                  </span>
                </div>

                <!-- Token Display -->
                <div class="mb-4">
                  <h4 class="text-xs font-medium text-gray-500 mb-1">
                    Access Token
                  </h4>
                  <div
                    id="access-token-display"
                    class="bg-white border border-gray-300 rounded-md p-3 text-sm font-mono text-gray-600 break-all max-h-24 overflow-y-auto"
                  >
                    None
                  </div>
                </div>

                <!-- Last Updated -->
                <div class="text-xs text-gray-500 flex items-center">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-3.5 w-3.5 mr-1"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  <span id="last-updated">Never connected</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="mt-8 grid grid-cols-1 md:grid-cols-3 gap-6">
          <div
            class="bg-white p-5 rounded-lg shadow border border-gray-200 flex items-start"
          >
            <div
              class="flex-shrink-0 h-10 w-10 rounded-md bg-primary-100 flex items-center justify-center text-primary-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                />
              </svg>
            </div>
            <div class="ml-4">
              <h3 class="text-sm font-medium text-gray-900">
                Secure Connection
              </h3>
              <p class="mt-1 text-xs text-gray-500">
                Your banking credentials are never stored on our servers
              </p>
            </div>
          </div>

          <div
            class="bg-white p-5 rounded-lg shadow border border-gray-200 flex items-start"
          >
            <div
              class="flex-shrink-0 h-10 w-10 rounded-md bg-primary-100 flex items-center justify-center text-primary-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                />
              </svg>
            </div>
            <div class="ml-4">
              <h3 class="text-sm font-medium text-gray-900">
                Bank-Level Security
              </h3>
              <p class="mt-1 text-xs text-gray-500">
                256-bit encryption and SOC2 compliance
              </p>
            </div>
          </div>

          <div
            class="bg-white p-5 rounded-lg shadow border border-gray-200 flex items-start"
          >
            <div
              class="flex-shrink-0 h-10 w-10 rounded-md bg-primary-100 flex items-center justify-center text-primary-600"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M13 10V3L4 14h7v7l9-11h-7z"
                />
              </svg>
            </div>
            <div class="ml-4">
              <h3 class="text-sm font-medium text-gray-900">
                Instant Verification
              </h3>
              <p class="mt-1 text-xs text-gray-500">
                Connect your account in seconds
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
      <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8">
        <div class="md:flex md:items-center md:justify-between">
          <div class="flex justify-center md:justify-start space-x-6">
            <a href="#" class="text-gray-400 hover:text-gray-500">
              <span class="sr-only">Privacy Policy</span>
              <span class="text-xs">Privacy Policy</span>
            </a>
            <a href="#" class="text-gray-400 hover:text-gray-500">
              <span class="sr-only">Terms of Service</span>
              <span class="text-xs">Terms of Service</span>
            </a>
            <a href="#" class="text-gray-400 hover:text-gray-500">
              <span class="sr-only">Contact</span>
              <span class="text-xs">Contact</span>
            </a>
          </div>
          <div class="mt-4 md:mt-0">
            <p class="text-center md:text-right text-xs text-gray-500">
              &copy; 2025 Plaid Connect. All rights reserved. Powered by
              <span class="text-primary-600">Plaid</span>
            </p>
          </div>
        </div>
      </div>
    </footer>

    <script>
      const connectButton = document.getElementById("connect-button");
      const statusMessage = document.getElementById("status-message");
      const accessTokenDisplay = document.getElementById(
        "access-token-display"
      );
      const connectionBadge = document.getElementById("connection-badge");
      const lastUpdated = document.getElementById("last-updated");

      function formatDate(date) {
        return new Intl.DateTimeFormat("en-US", {
          month: "short",
          day: "numeric",
          year: "numeric",
          hour: "numeric",
          minute: "numeric",
          hour12: true,
        }).format(date);
      }

      function updateConnectionStatus(isConnected) {
        if (isConnected) {
          connectionBadge.className =
            "px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800";
          connectionBadge.textContent = "Connected";
          lastUpdated.textContent = `Last updated: ${formatDate(new Date())}`;
        } else {
          connectionBadge.className =
            "px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800";
          connectionBadge.textContent = "Not Connected";
        }
      }

      function showLoading(isLoading) {
        if (isLoading) {
          connectButton.disabled = true;
          connectButton.innerHTML = `
          <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          Connecting...
        `;
          connectButton.classList.add("opacity-75");
        } else {
          connectButton.disabled = false;
          connectButton.innerHTML = "<span>Start Bank Connection</span>";
          connectButton.classList.remove("opacity-75");
        }
      }

      function showStatus(message, type) {
        statusMessage.textContent = message;
        statusMessage.classList.remove("hidden");

        if (type === "success") {
          statusMessage.className =
            "w-full mb-6 p-3 rounded-md bg-green-50 text-green-800 text-sm border border-green-200";
        } else if (type === "error") {
          statusMessage.className =
            "w-full mb-6 p-3 rounded-md bg-red-50 text-red-800 text-sm border border-red-200";
        } else if (type === "info") {
          statusMessage.className =
            "w-full mb-6 p-3 rounded-md bg-blue-50 text-blue-800 text-sm border border-blue-200";
        }

        setTimeout(() => {
          statusMessage.classList.add("hidden");
        }, 5000);
      }

      async function getLinkToken() {
        showLoading(true);
        try {
          const response = await fetch("http://localhost:5000/get_link_token");
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          const data = await response.json();
          showLoading(false);
          return data.link_token;
        } catch (error) {
          console.error("Failed to get link token:", error);
          showStatus(
            "Error getting link token. Please check your server connection.",
            "error"
          );
          showLoading(false);
          return null;
        }
      }

      async function exchangePublicToken(public_token) {
        showLoading(true);
        try {
          const response = await fetch(
            "http://localhost:5000/exchange_public_token",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ public_token }),
            }
          );

          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }

          const data = await response.json();
          if (data.access_token) {
            localStorage.setItem("plaid_access_token", data.access_token);
            localStorage.setItem(
              "plaid_connection_time",
              new Date().toISOString()
            );
            accessTokenDisplay.innerText = data.access_token;
            updateConnectionStatus(true);
            showStatus(
              "Access Token Received and Stored Successfully!",
              "success"
            );
          }
          showLoading(false);
        } catch (error) {
          console.error("Failed to exchange public token:", error);
          showStatus(
            "Error exchanging public token. Please try again.",
            "error"
          );
          showLoading(false);
        }
      }

      connectButton.onclick = async function () {
        showStatus("Initializing connection to your bank...", "info");
        const linkToken = await getLinkToken();
        if (!linkToken) return;

        var linkHandler = Plaid.create({
          token: linkToken,
          onSuccess: async function (public_token, metadata) {
            console.log("Bank Connected!", metadata);
            showStatus(
              `Successfully connected to ${metadata.institution.name}!`,
              "success"
            );
            await exchangePublicToken(public_token);
          },
          onLoad: function () {
            // The Link module finished loading
            showStatus("Plaid Link is ready. Please select your bank.", "info");
          },
          onExit: function (err, metadata) {
            console.log("User exited", err, metadata);
            if (err) {
              showStatus(
                `Connection error: ${err.display_message || err.error_message}`,
                "error"
              );
            } else if (metadata.status === "requires_questions") {
              showStatus(
                "Additional authentication required. Please try again.",
                "info"
              );
            } else if (metadata.status === "requires_selections") {
              showStatus("Please complete account selection.", "info");
            } else if (metadata.status === "requires_credentials") {
              showStatus("Please enter your credentials.", "info");
            } else {
              showStatus("Connection process was canceled.", "info");
            }
            showLoading(false);
          },
          onEvent: function (eventName, metadata) {
            console.log("Event:", eventName, metadata);
          },
        });

        linkHandler.open();
      };

      document.addEventListener("DOMContentLoaded", function () {
        const storedToken = localStorage.getItem("plaid_access_token");
        const connectionTime = localStorage.getItem("plaid_connection_time");

        if (storedToken) {
          accessTokenDisplay.innerText = storedToken;
          updateConnectionStatus(true);

          if (connectionTime) {
            lastUpdated.textContent = `Last updated: ${formatDate(
              new Date(connectionTime)
            )}`;
          }
        }
      });
    </script>
  </body>
</html>
